<!DOCTYPE html><html lang="en" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Auto published notes from Poulti's second brain"><meta name="author" content="Poulti"><link href="https://poulti.github.io/brain-pages/docker-from-compose-to-swarm/" rel="canonical"><link href="../autonomous-underearth-house/" rel="prev"><link rel="icon" href="../assets/images/favicon.png"><meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22"><title>Docker from compose to swarm - Brain pages</title><link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css"><link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel="stylesheet" href="../stylesheets/extra.css"><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head> <body dir="ltr" data-md-color-scheme="light" data-md-color-primary="amber" data-md-color-accent="orange"> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a href="#how-to-migrate-a-docker-compose-file-to-docker-swarm-mode" class="md-skip"> Skip to content </a> </div> <div data-md-component="announce"> </div> <header class="md-header md-header--shadow" data-md-component="header"> <nav class="md-header__inner md-grid" aria-label="Header"> <a href=".." title="Brain pages" class="md-header__button md-logo" aria-label="Brain pages" data-md-component="logo"> <!--?xml version="1.0" encoding="utf-8"?--> <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"> <path d="M 183.542 26.426 C 211.961 26.426 235.046 49.511 235.046 77.93 L 235.046 445.815 C 235.046 474.234 211.961 497.319 183.542 497.319 C 156.962 497.319 135.073 477.177 132.314 451.242 C 127.532 452.529 122.473 453.173 117.323 453.173 C 84.857 453.173 58.461 426.777 58.461 394.311 C 58.461 387.505 59.657 380.883 61.772 374.813 C 33.997 364.329 14.315 337.473 14.315 306.019 C 14.315 276.68 31.513 251.296 56.438 239.524 C 48.436 229.499 43.746 216.807 43.746 203.011 C 43.746 174.776 63.611 151.231 90.099 145.437 C 88.628 140.378 87.892 134.952 87.892 129.434 C 87.892 101.934 106.838 78.758 132.314 72.32 C 135.073 46.568 156.962 26.426 183.542 26.426 Z" style></path> <path d="M 351.816 274.992 C 368.695 274.992 386.643 276.703 405.232 280.121 L 405.232 312.171 C 391.985 308.753 374.037 307.044 351.816 307.044 C 311.218 307.044 279.382 314.094 255.666 328.197 L 255.666 292.087 C 280.664 280.762 312.714 274.992 351.816 274.992 M 255.666 235.038 C 283.228 223.713 315.279 218.157 351.816 218.157 C 368.695 218.157 386.643 219.653 405.232 223.072 L 405.232 255.122 C 391.985 251.704 374.037 249.994 351.816 249.994 C 311.218 249.994 279.382 257.259 255.666 271.146 M 351.816 193.158 C 311.218 193.158 279.382 199.995 255.666 214.524 L 255.666 179.057 C 281.947 167.091 313.997 161.108 351.816 161.108 C 368.695 161.108 386.643 162.817 405.232 166.022 L 405.232 199.141 C 389.42 195.082 371.258 193.158 351.816 193.158 M 426.599 364.092 L 426.599 118.376 C 404.378 111.323 379.378 107.691 351.816 107.691 C 308.014 107.691 268.912 118.376 234.299 139.741 L 234.299 385.459 C 268.912 364.092 308.014 353.409 351.816 353.409 C 377.241 353.409 402.241 356.827 426.599 364.092 M 351.816 64.958 C 402.027 64.958 441.342 75.641 469.332 97.008 L 469.332 408.108 C 469.332 410.671 468.265 413.236 465.913 415.586 C 463.563 417.509 461 419.219 458.649 419.219 C 456.299 419.219 454.589 418.791 453.308 418.149 C 425.959 403.407 391.985 396.142 351.816 396.142 C 308.014 396.142 268.912 406.825 234.299 428.193 C 234.341 402.424 233.786 117.541 234.299 97.008 C 262.93 75.641 302.031 64.958 351.816 64.958 Z" style></path> </svg> </a> <label class="md-header__button md-icon" for="__drawer"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> Brain pages </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> Docker from compose to swarm </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="light" data-md-color-primary="amber" data-md-color-accent="orange" aria-label="Come to the dark side" type="radio" name="__palette" id="__palette_0"> <label class="md-header__button md-icon" title="Come to the dark side" for="__palette_1" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"></path></svg> </label> <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="amber" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1"> <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required> <label class="md-search__icon md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav class="md-search__options" aria-label="Search"> <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list" role="presentation"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a href="https://github.com/poulti/brain-pages/" title="Go to repository" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg> </div> <div class="md-source__repository"> poulti/brain-pages </div> </a> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a href=".." title="Brain pages" class="md-nav__button md-logo" aria-label="Brain pages" data-md-component="logo"> <!--?xml version="1.0" encoding="utf-8"?--> <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"> <path d="M 183.542 26.426 C 211.961 26.426 235.046 49.511 235.046 77.93 L 235.046 445.815 C 235.046 474.234 211.961 497.319 183.542 497.319 C 156.962 497.319 135.073 477.177 132.314 451.242 C 127.532 452.529 122.473 453.173 117.323 453.173 C 84.857 453.173 58.461 426.777 58.461 394.311 C 58.461 387.505 59.657 380.883 61.772 374.813 C 33.997 364.329 14.315 337.473 14.315 306.019 C 14.315 276.68 31.513 251.296 56.438 239.524 C 48.436 229.499 43.746 216.807 43.746 203.011 C 43.746 174.776 63.611 151.231 90.099 145.437 C 88.628 140.378 87.892 134.952 87.892 129.434 C 87.892 101.934 106.838 78.758 132.314 72.32 C 135.073 46.568 156.962 26.426 183.542 26.426 Z" style></path> <path d="M 351.816 274.992 C 368.695 274.992 386.643 276.703 405.232 280.121 L 405.232 312.171 C 391.985 308.753 374.037 307.044 351.816 307.044 C 311.218 307.044 279.382 314.094 255.666 328.197 L 255.666 292.087 C 280.664 280.762 312.714 274.992 351.816 274.992 M 255.666 235.038 C 283.228 223.713 315.279 218.157 351.816 218.157 C 368.695 218.157 386.643 219.653 405.232 223.072 L 405.232 255.122 C 391.985 251.704 374.037 249.994 351.816 249.994 C 311.218 249.994 279.382 257.259 255.666 271.146 M 351.816 193.158 C 311.218 193.158 279.382 199.995 255.666 214.524 L 255.666 179.057 C 281.947 167.091 313.997 161.108 351.816 161.108 C 368.695 161.108 386.643 162.817 405.232 166.022 L 405.232 199.141 C 389.42 195.082 371.258 193.158 351.816 193.158 M 426.599 364.092 L 426.599 118.376 C 404.378 111.323 379.378 107.691 351.816 107.691 C 308.014 107.691 268.912 118.376 234.299 139.741 L 234.299 385.459 C 268.912 364.092 308.014 353.409 351.816 353.409 C 377.241 353.409 402.241 356.827 426.599 364.092 M 351.816 64.958 C 402.027 64.958 441.342 75.641 469.332 97.008 L 469.332 408.108 C 469.332 410.671 468.265 413.236 465.913 415.586 C 463.563 417.509 461 419.219 458.649 419.219 C 456.299 419.219 454.589 418.791 453.308 418.149 C 425.959 403.407 391.985 396.142 351.816 396.142 C 308.014 396.142 268.912 406.825 234.299 428.193 C 234.341 402.424 233.786 117.541 234.299 97.008 C 262.93 75.641 302.031 64.958 351.816 64.958 Z" style></path> </svg> </a> Brain pages </label> <div class="md-nav__source"> <a href="https://github.com/poulti/brain-pages/" title="Go to repository" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg> </div> <div class="md-source__repository"> poulti/brain-pages </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href=".." class="md-nav__link"> <span class="md-ellipsis"> Home </span> </a> </li> <li class="md-nav__item"> <a href="../autonomous-underearth-house/" class="md-nav__link"> <span class="md-ellipsis"> Autonomous underearth house </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc"> <label class="md-nav__link md-nav__link--active" for="__toc"> <span class="md-ellipsis"> Docker from compose to swarm </span> <span class="md-nav__icon md-icon"></span> </label> <a href="./" class="md-nav__link md-nav__link--active"> <span class="md-ellipsis"> Docker from compose to swarm </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#0-backstory-home-assistant-in-a-container" class="md-nav__link"> <span class="md-ellipsis"> 0. Backstory: Home Assistant in a container </span> </a> <nav class="md-nav" aria-label="0. Backstory: Home Assistant in a container"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#a-first-docker-compose-running-on-windows-docker-desktop" class="md-nav__link"> <span class="md-ellipsis"> A first docker compose, running on windows / docker desktop </span> </a> </li> <li class="md-nav__item"> <a href="#adding-more-container-to-compose-and-more-complexity" class="md-nav__link"> <span class="md-ellipsis"> Adding more container to compose... and more complexity </span> </a> </li> <li class="md-nav__item"> <a href="#thinking-of-the-migration-to-a-cluster-docker-swarm" class="md-nav__link"> <span class="md-ellipsis"> Thinking of the migration to a cluster... (Docker Swarm) </span> </a> </li> <li class="md-nav__item"> <a href="#looking-at-swarm-mode-what-changes-vs-compose" class="md-nav__link"> <span class="md-ellipsis"> Looking at Swarm Mode: what changes vs Compose? </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#1-how-to-deploy-a-compose-file-in-swarm-mode" class="md-nav__link"> <span class="md-ellipsis"> 1. How to deploy a compose file in swarm mode? </span> </a> <nav class="md-nav" aria-label="1. How to deploy a compose file in swarm mode?"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#but-the-compose-file-doesnt-work-as-is-in-swarm-mode-what-needs-to-be-changed-to-work-with-swarm-mode" class="md-nav__link"> <span class="md-ellipsis"> ...but the compose file doesn't work AS-IS in Swarm Mode! What needs to be changed to work with Swarm Mode? </span> </a> <nav class="md-nav" aria-label="...but the compose file doesn't work AS-IS in Swarm Mode! What needs to be changed to work with Swarm Mode?"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#workaround-for-shm_size-in-swarm-mode" class="md-nav__link"> <span class="md-ellipsis"> Workaround for shm_size in Swarm Mode </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#2-how-to-access-bound-folders-in-swarm-mode-volumes-and-storage" class="md-nav__link"> <span class="md-ellipsis"> 2. How to access bound folders in swarm mode? (Volumes and storage) </span> </a> </li> <li class="md-nav__item"> <a href="#3-how-to-access-usb-devices-in-swarm-mode" class="md-nav__link"> <span class="md-ellipsis"> 3. How to access USB devices in swarm mode? </span> </a> <nav class="md-nav" aria-label="3. How to access USB devices in swarm mode?"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#create-rules-to-mount-the-device-as-a-volume" class="md-nav__link"> <span class="md-ellipsis"> Create rules to mount the device as a volume </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#4-cluster-configuration-and-deployment-ansible" class="md-nav__link"> <span class="md-ellipsis"> 4. Cluster configuration and deployment (Ansible) </span> </a> <nav class="md-nav" aria-label="4. Cluster configuration and deployment (Ansible)"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#set-cgroups-config" class="md-nav__link"> <span class="md-ellipsis"> Set cgroups config </span> </a> </li> <li class="md-nav__item"> <a href="#rest-of-the-playbook" class="md-nav__link"> <span class="md-ellipsis"> Rest of the playbook </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#0-backstory-home-assistant-in-a-container" class="md-nav__link"> <span class="md-ellipsis"> 0. Backstory: Home Assistant in a container </span> </a> <nav class="md-nav" aria-label="0. Backstory: Home Assistant in a container"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#a-first-docker-compose-running-on-windows-docker-desktop" class="md-nav__link"> <span class="md-ellipsis"> A first docker compose, running on windows / docker desktop </span> </a> </li> <li class="md-nav__item"> <a href="#adding-more-container-to-compose-and-more-complexity" class="md-nav__link"> <span class="md-ellipsis"> Adding more container to compose... and more complexity </span> </a> </li> <li class="md-nav__item"> <a href="#thinking-of-the-migration-to-a-cluster-docker-swarm" class="md-nav__link"> <span class="md-ellipsis"> Thinking of the migration to a cluster... (Docker Swarm) </span> </a> </li> <li class="md-nav__item"> <a href="#looking-at-swarm-mode-what-changes-vs-compose" class="md-nav__link"> <span class="md-ellipsis"> Looking at Swarm Mode: what changes vs Compose? </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#1-how-to-deploy-a-compose-file-in-swarm-mode" class="md-nav__link"> <span class="md-ellipsis"> 1. How to deploy a compose file in swarm mode? </span> </a> <nav class="md-nav" aria-label="1. How to deploy a compose file in swarm mode?"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#but-the-compose-file-doesnt-work-as-is-in-swarm-mode-what-needs-to-be-changed-to-work-with-swarm-mode" class="md-nav__link"> <span class="md-ellipsis"> ...but the compose file doesn't work AS-IS in Swarm Mode! What needs to be changed to work with Swarm Mode? </span> </a> <nav class="md-nav" aria-label="...but the compose file doesn't work AS-IS in Swarm Mode! What needs to be changed to work with Swarm Mode?"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#workaround-for-shm_size-in-swarm-mode" class="md-nav__link"> <span class="md-ellipsis"> Workaround for shm_size in Swarm Mode </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#2-how-to-access-bound-folders-in-swarm-mode-volumes-and-storage" class="md-nav__link"> <span class="md-ellipsis"> 2. How to access bound folders in swarm mode? (Volumes and storage) </span> </a> </li> <li class="md-nav__item"> <a href="#3-how-to-access-usb-devices-in-swarm-mode" class="md-nav__link"> <span class="md-ellipsis"> 3. How to access USB devices in swarm mode? </span> </a> <nav class="md-nav" aria-label="3. How to access USB devices in swarm mode?"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#create-rules-to-mount-the-device-as-a-volume" class="md-nav__link"> <span class="md-ellipsis"> Create rules to mount the device as a volume </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#4-cluster-configuration-and-deployment-ansible" class="md-nav__link"> <span class="md-ellipsis"> 4. Cluster configuration and deployment (Ansible) </span> </a> <nav class="md-nav" aria-label="4. Cluster configuration and deployment (Ansible)"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#set-cgroups-config" class="md-nav__link"> <span class="md-ellipsis"> Set cgroups config </span> </a> </li> <li class="md-nav__item"> <a href="#rest-of-the-playbook" class="md-nav__link"> <span class="md-ellipsis"> Rest of the playbook </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <blockquote> <p>A homelab story from 2023 to 2025+...</p> </blockquote> <h1 id="how-to-migrate-a-docker-compose-file-to-docker-swarm-mode">How to migrate a docker compose file to Docker Swarm Mode?</h1> <p>...from <code>docker compose up -d</code> to <code>docker stack deploy --compose-file docker-compose.yaml ha</code></p> <h2 id="0-backstory-home-assistant-in-a-container">0. Backstory: Home Assistant in a container</h2> <p>How did it start... for context:</p> <blockquote> <p><em>Like a good chunk of 30yo+, I bought a (couple of) Raspberry without knowing what to do with it...</em></p> <p><em>After installing a PKI and OpenVPN manually on a Raspberry Pi 4 (and that's a lot of commands), I've been wanting a more flexible way to install/remove/update stuff on it - particularly because I hate having apps installed directly on the OS, and the thought of needing to reinstall and configure everything should I need to replace/upgrade the hardware. Enter </em><em>containers</em>*: a packaged system/app I can deploy with 1 action/no install, and when it stops, it (almost) doesn't leave anything to clean up.</p> <p><em>But what if I want to run more things? and being resilient to the raspberry or sd card dying? That'd be fun to have a cluster of Raspberry Pi... which led me to find the Turing Pi 2 cluster board. And as I researched what people usually deploy on Raspberry clusters, I kept seeing the Home Assistant logo...</em></p> <p><em>So I looked at it up close while waiting for the Turing Pi 2 to release - I thought I would run the containers directly on my desktop using Docker Compose. And if I did it right, I would "just" have to move my containers to the new hardware once ready, right?... well, not that simple unfortunately...</em></p> <p><em>This page is the combined notes going through that journey, because for many topics I struggled to find clarity, I thought I'd make this public. I'm not a professional blogger so please excuse the clunky style - just hope it is useful to someone somewhere!</em></p> </blockquote> <h3 id="a-first-docker-compose-running-on-windows-docker-desktop">A first docker compose, running on windows / docker desktop</h3> <p>So I started creating a docker compose file to run on Docker for Windows, with just Home Assistant to begin with. That's pretty simple at that stage, you can find examples of docker compose file on the official website. Below is the simplified copy of one of the first compose file:</p> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-0-1"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.9'</span>
</span><span id="__span-0-2">
</span><span id="__span-0-3"><span class="nt">services</span><span class="p">:</span>
</span><span id="__span-0-4"><span class="w">  </span><span class="nt">homeassistant</span><span class="p">:</span>
</span><span id="__span-0-5"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeassistant</span>
</span><span id="__span-0-6"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeassistant</span>
</span><span id="__span-0-7"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">"ghcr.io/home-assistant/home-assistant:stable"</span>
</span><span id="__span-0-8"><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span><span id="__span-0-9"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-0-10"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"8123:8123/tcp"</span>
</span><span id="__span-0-11"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-0-12"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TZ=Europe/London</span>
</span><span id="__span-0-13"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-0-14"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hass-config:/config</span>
</span><span id="__span-0-15"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/localtime:/etc/localtime:ro</span>
</span><span id="__span-0-16">
</span><span id="__span-0-17"><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-0-18"><span class="w">  </span><span class="nt">hass-config</span><span class="p">:</span>
</span><span id="__span-0-19"><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-0-20"><span class="w">    </span><span class="nt">driver_opts</span><span class="p">:</span>
</span><span id="__span-0-21"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">none</span>
</span><span id="__span-0-22"><span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">D:\HomeAssistant\hass\config</span>
</span><span id="__span-0-23"><span class="w">      </span><span class="nt">o</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bind</span>
</span></code></pre></div> <blockquote> <p>Here are the main things to know about the sections of a docker compose file:</p> <ul> <li> <p><code>services</code>: this where you declare the "machine" (container) and detail settings </p> </li> <li> <p><code>volumes</code>: this is the configuration of storage volumes for the container. The point is to store your custom config for the machine outside the container, to be able to back it up and restart the container in the same state.</p> </li> <li>In this Windows hosted container, I configured the storage to map (bind) the volume named <code>hass-config</code> to a local folder on my Windows machine, at <code>D:\HomeAssistant\hass\config</code></li> </ul> </blockquote> <p>...but the point is to automate and control "things" remotely, so I added a Zigbee controller, buying a £15 Zonoff USB Zigbee dongle on Amazon. To make it work, decided to use zigbee2mqtt as the service to connect with it, and hence I needed an MQTT server (eg mosquitto) in between home assistant and zigbee2mqtt. MQTT is a communication protocol commonly used in industrial environment. Here, it's used to link the ZigBee receiver, and Home Assistant.</p> <p>Updated docker compose looked like this:</p> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-1-1"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">'3.9'</span>
</span><span id="__span-1-2">
</span><span id="__span-1-3"><span class="nt">services</span><span class="p">:</span>
</span><span id="__span-1-4"><span class="w">  </span><span class="nt">homeassistant</span><span class="p">:</span>
</span><span id="__span-1-5"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeassistant</span>
</span><span id="__span-1-6"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeassistant</span>
</span><span id="__span-1-7"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s">"ghcr.io/home-assistant/home-assistant:stable"</span>
</span><span id="__span-1-8"><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span><span id="__span-1-9"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-1-10"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"8123:8123/tcp"</span>
</span><span id="__span-1-11"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-1-12"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TZ=Europe/London</span>
</span><span id="__span-1-13"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-1-14"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hass-config:/config</span>
</span><span id="__span-1-15"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/localtime:/etc/localtime:ro</span>
</span><span id="__span-1-16">
</span><span id="__span-1-17"><span class="w">  </span><span class="nt">mosquitto</span><span class="p">:</span>
</span><span id="__span-1-18"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mosquitto</span>
</span><span id="__span-1-19"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mosquitto</span>
</span><span id="__span-1-20"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eclipse-mosquitto</span>
</span><span id="__span-1-21"><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span><span id="__span-1-22"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-1-23"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1883:1883</span>
</span><span id="__span-1-24"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9001:9001</span>
</span><span id="__span-1-25"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-1-26"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TZ=Europe/London</span>
</span><span id="__span-1-27"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-1-28"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mosquitto-config:/mosquitto:rw</span>
</span><span id="__span-1-29">
</span><span id="__span-1-30"><span class="w">  </span><span class="nt">zigbee2mqtt</span><span class="p">:</span>
</span><span id="__span-1-31"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zigbee2mqtt</span>
</span><span id="__span-1-32"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zigbee2mqtt</span>
</span><span id="__span-1-33"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">koenkk/zigbee2mqtt</span>
</span><span id="__span-1-34"><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</span><span id="__span-1-35"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
</span><span id="__span-1-36"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080:8080</span>
</span><span id="__span-1-37"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
</span><span id="__span-1-38"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TZ=Europe/London</span>
</span><span id="__span-1-39"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-1-40"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zigbee2mqtt-data:/app/data</span>
</span><span id="__span-1-41"><span class="w">    </span><span class="nt">devices</span><span class="p">:</span>
</span><span id="__span-1-42"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/ttyUSB0:/dev/zigbee</span>
</span><span id="__span-1-43">
</span><span id="__span-1-44">
</span><span id="__span-1-45"><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-1-46"><span class="w">  </span><span class="nt">hass-config</span><span class="p">:</span>
</span><span id="__span-1-47"><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-1-48"><span class="w">    </span><span class="nt">driver_opts</span><span class="p">:</span>
</span><span id="__span-1-49"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">none</span>
</span><span id="__span-1-50"><span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">D:\HomeAssistant\hass\config</span>
</span><span id="__span-1-51"><span class="w">      </span><span class="nt">o</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bind</span>
</span><span id="__span-1-52"><span class="w">  </span><span class="nt">mosquitto-config</span><span class="p">:</span>
</span><span id="__span-1-53"><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-1-54"><span class="w">    </span><span class="nt">driver_opts</span><span class="p">:</span>
</span><span id="__span-1-55"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">none</span>
</span><span id="__span-1-56"><span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">D:\HomeAssistant\mosquitto</span>
</span><span id="__span-1-57"><span class="w">      </span><span class="nt">o</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bind</span>
</span><span id="__span-1-58"><span class="w">  </span><span class="nt">zigbee2mqtt-data</span><span class="p">:</span>
</span><span id="__span-1-59"><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-1-60"><span class="w">    </span><span class="nt">driver_opts</span><span class="p">:</span>
</span><span id="__span-1-61"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">none</span>
</span><span id="__span-1-62"><span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">D:\HomeAssistant\zigbee2mqtt-data</span>
</span><span id="__span-1-63"><span class="w">      </span><span class="nt">o</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bind</span>
</span></code></pre></div> <p>Notice the addition of the USB device used by Zigbee2MQTT container? </p><div class="language-yaml highlight"><pre><span></span><code><span id="__span-2-1"><span class="w">  </span><span class="nt">zigbee2mqtt</span><span class="p">:</span>
</span><span id="__span-2-2"><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span><span id="__span-2-3"><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">devices</span><span class="p p-Indicator">:</span>
</span><span id="__span-2-4"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/ttyUSB0:/dev/zigbee</span>
</span></code></pre></div><p></p> <p>As the containers are actually run in Windows Subsystem for Linux (aka WSL, a linux environment in Windows OS) the <code>devices</code> reference above needs to give the path to a USB device known to the WSL... so how do you get a USB device connected to your Windows machine, to the WSL?</p> <p>Enters USBIP-WIN: "Windows software for sharing locally connected USB devices to other machines, including Hyper-V guests and WSL 2." according to <a href="https://github.com/dorssel/usbipd-win">its github</a>.</p> <p>Wait, it says "WSL 2"? By default, Windows uses WSL "1", so you'll find below how to switch to WSL 2 and install a linux distribution in it. Here are some of notes on the process:</p> <ul> <li>In BIOS, turn on VT-x</li> <li>In a cmd or powershell run as admin: <div class="language-text highlight"><pre><span></span><code><span id="__span-3-1">wsl --install
</span></code></pre></div></li> <li>Reboot</li> <li>Update the WSL <div class="language-text highlight"><pre><span></span><code><span id="__span-4-1">wsl --update
</span></code></pre></div></li> <li>Set it to WSL 2 <div class="language-text highlight"><pre><span></span><code><span id="__span-5-1">wsl --set-default-version 2
</span></code></pre></div></li> <li>Download a distro, eg Ubuntu 22.04 LTS, go to https://aka.ms/wslubuntu2204 (Go to Microsoft Store app, and search Ubuntu, download), and open the .appbundle</li> <li>Install the distro (not sure that step is necessary anymore if you opened the appbundle in the UI): <div class="language-text highlight"><pre><span></span><code><span id="__span-6-1">wsl --install -d ubuntu
</span></code></pre></div></li> </ul> <p>Then follow the steps to install USBIP-WIN from the github above.</p> <p>At that stage you have the foundation of home assistant and docker services, and ZigBee network connected. Time to expand to even more services!</p> <h3 id="adding-more-container-to-compose-and-more-complexity">Adding more container to compose... and more complexity</h3> <p>From here, everything is possible - without a specific order, you can add a variety of things:</p> <ul> <li>An RFlink device (USB) to access weather stations signals (radio frequencies on 433MHz)</li> <li>A back up service for the whole configuration (eg. duplicati)</li> <li>A reverse proxy for external access (Traefik or nginx)</li> <li>A Network Video Recording (Frigate) to manage cameras ...</li> </ul> <p>For example, leading to a structure like this:</p> <pre class="mermaid"><code>graph BT
  subgraph WIN[Software]
    direction BT
    subgraph Docker[WSL2]
      direction BT
      d[Docker Deamon] --&gt; c1[Home Assistant]
      d --&gt; c2[Frigate]
      d --&gt; c3[...]
      d --&gt; c4[Zigbee2MQTT]
      d --&gt; c5[Mosquitto]
    end
    USBIP --&gt; Docker
    Windows --&gt; USBIP
  end
  Hardware --&gt; WIN
  subgraph Hardware[Desktop Hardware]
    direction LR
    ZigBee --&gt; USB
    RFLink --&gt; USB
  end</code></pre> <h3 id="thinking-of-the-migration-to-a-cluster-docker-swarm">Thinking of the migration to a cluster... (Docker Swarm)</h3> <p>From here, I still didn't have my Turing Pi and many nodes, but I wanted to get ready for it. Actually, quick research taught me it's possible to run the same containers in Swarm mode on 1 node. Docker Swarm mode is designed to manage multiple machines (called nodes) each having their own docker instance, and distributing the containers between the machines. So it actually works with only 1 machine, but you don't get the redundancy of multiple node of course. The other good news is the switch to Swarm Mode (in Docker) is reversible: you can switch to Swarm Mode (with one machine) and "exit" Swarm Mode to return to the "normal" compose file reference - so you don't risk much in preparing files/config for Swarm. And you'll see later that you can leave your Swarm Mode on and still "compose up" on the same machine.</p> <h3 id="looking-at-swarm-mode-what-changes-vs-compose">Looking at Swarm Mode: what changes vs Compose?</h3> <p>A couple of questions came up when thinking of the migration to Swarm Mode:</p> <ul> <li>How to deploy a <strong>compose file</strong> in swarm mode?</li> <li>How to access <strong>bound folders</strong> in swarm mode?</li> <li>How to access <strong>USB devices</strong> in swarm mode?</li> <li>How to <strong>restart</strong> malfunctioning containers/services? (like self-healing from k8s)</li> </ul> <p>Let's go through these questions one by one</p> <h2 id="1-how-to-deploy-a-compose-file-in-swarm-mode">1. How to deploy a <strong>compose file</strong> in swarm mode?</h2> <p>Before switching to the cluster, you can test the updated compose file for Swarm Mode, by deploying the stack on a Swarm of 1 node. And if it doesn't work, remove the stack and compose up instead. No need to exit/delete the swarm to use the regular compose up.</p> <ul> <li>To deploy the compose file on a Swarm: <div class="language-text highlight"><pre><span></span><code><span id="__span-7-1">docker stack deploy --compose-file docker-compose.yaml homeassistant
</span></code></pre></div></li> </ul> <p>...and once finished</p> <ul> <li>To stop it: <div class="language-text highlight"><pre><span></span><code><span id="__span-8-1">docker stack rm homeassistant
</span></code></pre></div></li> </ul> <h3 id="but-the-compose-file-doesnt-work-as-is-in-swarm-mode-what-needs-to-be-changed-to-work-with-swarm-mode">...but the compose file doesn't work AS-IS in Swarm Mode! What needs to be changed to work with Swarm Mode?</h3> <p>Docker compose reference is slightly different for swarm mode, i.e. some keywords are ignored or not working in swarm mode.</p> <p>This is not a comprehensive list (refer to the compose reference for that), but that's all the things I had to tinker with in my compose file to make it swarm friendly:</p> <ul> <li><code>privileged: true</code> <ul> <li>Ignored in swarm. You should not need it </li> </ul> </li> <li><code>restart: always</code><ul> <li>Ignored in Swarm. Not an issue as swarm services will be destroyed / recreated as necessary (to reach the constraints)</li> </ul> </li> <li><code>container_name:</code> <ul> <li>Ignored in swarm. Doesn't really matter anyway?</li> </ul> </li> <li><code>volume / binds (inline):</code> <ul> <li>Similar to the USB devices, you can't mount bind on a node, while services are moving potentially on any node of the cluster.</li> </ul> </li> <li><code>device:</code> <ul> <li>Ignored in swarm. Ok this one is an issue, particularly with our USB devices needed to communicate with the real world (Zigbee bridge, RFlink or Coral accelerator etc.)</li> </ul> </li> <li><code>shm_size:</code><ul> <li>Ignored in swarm. This is a buffer for cameras. See below for a workaround</li> <li>https://docs.frigate.video/installation/#calculating-required-shm-size</li> </ul> </li> </ul> <h4 id="workaround-for-shm_size-in-swarm-mode">Workaround for shm_size in Swarm Mode</h4> <p>Since the parameter shm_size does not work in Swarm Mode, you can replace it with a tmpfs volume, as below:</p> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-9-1"><span class="nt">services</span><span class="p">:</span>
</span><span id="__span-9-2"><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span><span id="__span-9-3"><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">frigate</span><span class="p p-Indicator">:</span>
</span><span id="__span-9-4"><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span><span id="__span-9-5"><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">volume</span><span class="p p-Indicator">:</span>
</span><span id="__span-9-6"><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span><span id="__span-9-7"><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">- type</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tmpfs</span><span class="w"> </span><span class="c1"># Optional: 1GB of memory, reduces SSD/SD Card wear</span>
</span><span id="__span-9-8"><span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/cache</span>
</span><span id="__span-9-9"><span class="w">        </span><span class="nt">tmpfs</span><span class="p">:</span>
</span><span id="__span-9-10"><span class="w">          </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000000000</span>
</span><span id="__span-9-11"><span class="w">    </span><span class="c1"># shm_size: "190mb" # update for your cameras based on calculation below (each Tapo is ~27mb and G4 is ~53mb)</span>
</span><span id="__span-9-12"><span class="w">    </span><span class="c1"># (width * height * 1.5 * 9 + 270480)/1048576 = &lt;shm size in mb&gt; for each camera</span>
</span><span id="__span-9-13"><span class="w">    </span><span class="c1"># The below volume replaces shm_size for swarm mode</span>
</span><span id="__span-9-14"><span class="w">    </span><span class="w w-Error">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tmpfs</span>
</span><span id="__span-9-15"><span class="w">        </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/shm</span>
</span><span id="__span-9-16"><span class="w">        </span><span class="nt">tmpfs</span><span class="p">:</span>
</span><span id="__span-9-17"><span class="w">           </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">190000000</span><span class="w"> </span><span class="c1"># (this means 190mb)</span>
</span></code></pre></div> <p>The next sections focus on the volume / folders access in swarm, then on how to passe a USB device.</p> <h2 id="2-how-to-access-bound-folders-in-swarm-mode-volumes-and-storage">2. How to access <strong>bound folders</strong> in swarm mode? (Volumes and storage)</h2> <p>In swarm mode, you can't bind a local folder, because you can't predict on which node a given container will be located. You could force the assignment of a container to a given node with docker constraints and labels, but that would defeat the purpose of running a cluster (ie. having container able to move around based on the availability of the underlying machines (node)).</p> <p>I found two approaches that seem to mitigate this:</p> <ul> <li>Have a filesystem that replicates the content over all nodes (ie. each Raspberry Pi or RK1 modules would have a copy of the entire dataset). Sounds great for data access performance, but obviously it requires enough space on each node and as the lab grows up, will it scale on those poor little 32GB sd cards? Just that idea stopped me from exploring this option further.</li> <li>Or access the data from a network share - which means having all the date in 1 place (one node, or somewhere else...), open it to be shared on the network (eg. NFS) and access it from the nodes. One way to configure this on the container side is to use volumes, see below the description</li> </ul> <p><a href="https://stackoverflow.com/questions/55288453/docker-volume-in-swarm">Volumes in swarm</a></p> <blockquote> <p>A volume is a way for docker to describe a mount point. When a volume get created, it doesn't actually get physically mounted anywhere until a container needs it. So if you have a docker swarm and multiple nodes, when you create a volume, essentially the description of the volume gets replicated on each nodes but nothing else happens. When a container boot up, it will try to mount a volume on the host its being booted up. If the volume wasn't physically present it will get mounted/created for the first time and reused there. So if you're using the local driver, it will essentially create the folder and that's it. If you have multiple hosts, it means each host will create its own folder on demand.</p> </blockquote> <p>Practically, I would use volumes in the compose file (which was already the case) and replace the "bound" volumes with NFS ones</p> <p>For instance, the first volume in the compose file was: </p><div class="language-yaml highlight"><pre><span></span><code><span id="__span-10-1"><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span><span id="__span-10-2"><span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
</span><span id="__span-10-3"><span class="w">  </span><span class="nt">hass-config</span><span class="p">:</span>
</span><span id="__span-10-4"><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-10-5"><span class="w">    </span><span class="nt">driver_opts</span><span class="p">:</span>
</span><span id="__span-10-6"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">none</span>
</span><span id="__span-10-7"><span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">D:\HomeAssistant\hass\config</span>
</span><span id="__span-10-8"><span class="w">      </span><span class="nt">o</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bind</span>
</span><span id="__span-10-9"><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span></code></pre></div> ...and would now look something like: <div class="language-yaml highlight"><pre><span></span><code><span id="__span-11-1"><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span><span id="__span-11-2"><span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
</span><span id="__span-11-3"><span class="w">  </span><span class="nt">hass-config</span><span class="p">:</span>
</span><span id="__span-11-4"><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
</span><span id="__span-11-5"><span class="w">    </span><span class="nt">driver_opts</span><span class="p">:</span>
</span><span id="__span-11-6"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs4</span>
</span><span id="__span-11-7"><span class="w">      </span><span class="nt">o</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfsvers=4,addr=&lt;IP-OF-THE-NFS-SERVER&gt;,nolock,rw,sync</span>
</span><span id="__span-11-8"><span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">":/&lt;nfssharepath&gt;/HomeAssistant/hass/config"</span>
</span><span id="__span-11-9"><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span></code></pre></div><p></p> <h2 id="3-how-to-access-usb-devices-in-swarm-mode">3. How to access <strong>USB devices</strong> in swarm mode?</h2> <p>Couple things to deal with:</p> <ol> <li> <p>Problem: by construction, services in a swarm can be run on any node... which will not work if we need to access a specific USB device plugged into it. Can't wait to be lucky and be on the right node... Solution:</p> <ul> <li>For this we are going to use the swarm specific section "deploy" to indicate a constraints (=rule) for the service needing the USB device. It requires "tagging" the node with labels in the first place, then using docker deploy constraints. </li> <li>In the example below, the constraint says the node should have a label named "usb2" with a value equal to "true". <div class="language-yaml highlight"><pre><span></span><code><span id="__span-12-1"><span class="nt">services</span><span class="p">:</span>
</span><span id="__span-12-2"><span class="w">    </span><span class="nt">myService</span><span class="p">:</span>
</span><span id="__span-12-3"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span><span id="__span-12-4"><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">(...)</span><span class="w">        </span>
</span><span id="__span-12-5"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span>
</span><span id="__span-12-6"><span class="w">            </span><span class="nt">placement</span><span class="p">:</span>
</span><span id="__span-12-7"><span class="w">                </span><span class="nt">constraints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">node.labels.usb2 == true</span><span class="p p-Indicator">]</span>
</span><span id="__span-12-8"><span class="w">            </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span></code></pre></div></li> <li>Btw, adding such a label to a node is achieved by executing the following command on a manager node: <div class="language-sh highlight"><pre><span></span><code><span id="__span-13-1">docker<span class="w"> </span>node<span class="w"> </span>update<span class="w"> </span>--label-add<span class="w"> </span><span class="nv">usb2</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span>&lt;name<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>node&gt;
</span></code></pre></div></li> </ul> </li> <li> <p>Even on the right node, how can we pass the USB device to the docker container... without the "device" section?</p> <ul> <li>This one is trickier, we have to pass the device as a <strong>volume</strong>, and manually authorise the device for the container using a number of scripts This is described in the next section in more details.</li> </ul> </li> <li> <p>A pre-requisite: switch to cgroups v1 (vs v2)</p> <ul> <li>cgroups are used to limit the amount of memory that is available to a particular group of processes (not sure how that definition is relevant in this case). In the below, we use cgroups directly authorisation to allow a container to access a device, using its path, passing it as a volume.</li> <li>Modern linux distro adopted cgroups v2 architecture around 2016... and the trick to access a device and mount it as a volume (described in next section in details) requires cgroups v1. I only realised that when switching to the cluster, as for some reason (maybe an old kernel), WSL was still using cgroups v1 and everything was working fine.</li> <li>To know which version your system is using, run the following:<ul> <li><code>stat -fc %T /sys/fs/cgroup/</code><ul> <li>For cgroup v2, the output is <code>cgroup2fs</code>.</li> <li>For cgroup v1, the output is <code>tmpfs</code>.</li> </ul> </li> </ul> </li> <li>To fore the system to use cgroups v1, on a raspberry, edit the file <code>/boot/cmdline.txt</code> and add:<ul> <li><code>systemd.unified_cgroup_hierarchy=false</code></li> </ul> </li> <li><em>Not sure what those commands do, but I'll keep them here for now as I got them while researching</em> (maybe for the non raspberry devices, like RK1?)<ul> <li>sudo mkdir /sys/fs/cgroup/devices</li> <li>sudo mount -t cgroup -o devices none /sys/fs/cgroup/devices</li> </ul> </li> </ul> </li> </ol> <h3 id="create-rules-to-mount-the-device-as-a-volume">Create rules to mount the device as a volume</h3> <p>For the container to be allowed to access the device while passing a volume, we need to give the authorisation (via cgroups) to the container. Since the container ID changes at each execution, we need the scripts and wrappers below to automatically find the right information and create the authorisation.</p> <p>The idea is as follows:</p> <ol> <li>The UDEV rule detects a USB device with a given vendor id and product id, then assigns it a name (symlink) and runs a 'docker-setup-<em>device</em>.sh' shell script.</li> <li>The 'docker-setup-<em>device</em>.sh' script finds the CID of a given container, by name and adds the authorisations for the USB device to the devices.allow file for this container.</li> <li>Device access authorisations are hardcoded for the Coral to <code>c 189:* rwm</code> because it changes vendor and product id after first inference (ie the USB device is different when you plug it and after first access)</li> <li>The service makes sure the script in 2. is executed regularly (because the UDEV rule is only activated when the USB device is plugged)</li> <li>A script is run by the service, to loop-execute the script in 2.</li> </ol> <p>Example with my zigbee USB stick (since then, I upgraded to a ETH version, but that still applies to the RFlink)</p> <ol> <li> <p>UDEV rule: <code>/etc/udev/rules.d/99-zigbee.rules</code></p> <div class="language-sh highlight"><span class="filename">99-zigbee.rules</span><pre><span></span><code><span id="__span-14-1"><span class="nv">SUBSYSTEM</span><span class="o">==</span><span class="s2">"tty"</span>,<span class="w"> </span>ATTRS<span class="o">{</span>idVendor<span class="o">}==</span><span class="s2">"10c4"</span>,<span class="w"> </span>ATTRS<span class="o">{</span>idProduct<span class="o">}==</span><span class="s2">"ea60"</span>,<span class="w"> </span><span class="nv">SYMLINK</span><span class="o">+=</span><span class="s2">"zigbee"</span>,<span class="w">  </span><span class="nv">RUN</span><span class="o">+=</span><span class="s2">"/usr/local/bin/docker-setup-zigbee.sh"</span>
</span></code></pre></div> </li> <li> <p>Shell script to set up the permissions: <code>/usr/local/bin/docker-setup-zigbee.sh</code></p> <div class="language-shell highlight"><span class="filename">docker-setup-zigbee.sh</span><pre><span></span><code><span id="__span-15-1"><span class="ch">#!/bin/bash</span>
</span><span id="__span-15-2"><span class="nv">USBDEV</span><span class="o">=</span><span class="sb">`</span>readlink<span class="w"> </span>-f<span class="w"> </span>/dev/zigbee<span class="sb">`</span><span class="w"> </span><span class="c1"># (1)!</span>
</span><span id="__span-15-3"><span class="nb">read</span><span class="w"> </span>minor<span class="w"> </span>major<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>stat<span class="w"> </span>-c<span class="w"> </span><span class="s1">'%T %t'</span><span class="w"> </span><span class="nv">$USBDEV</span><span class="o">)</span>
</span><span id="__span-15-4"><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$minor</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$major</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-15-5"><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">'Device not found'</span>
</span><span id="__span-15-6"><span class="w">  </span><span class="nb">exit</span>
</span><span id="__span-15-7"><span class="k">fi</span>
</span><span id="__span-15-8"><span class="nv">dminor</span><span class="o">=</span><span class="k">$((</span><span class="m">0</span><span class="nv">x</span><span class="si">${</span><span class="nv">minor</span><span class="si">}</span><span class="k">))</span>
</span><span id="__span-15-9"><span class="nv">dmajor</span><span class="o">=</span><span class="k">$((</span><span class="m">0</span><span class="nv">x</span><span class="si">${</span><span class="nv">major</span><span class="si">}</span><span class="k">))</span>
</span><span id="__span-15-10"><span class="nv">CID</span><span class="o">=</span><span class="sb">`</span>docker<span class="w"> </span>ps<span class="w"> </span>-a<span class="w"> </span>--no-trunc<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>zigbee2mqtt<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="w"> </span><span class="p">|</span><span class="w">  </span>awk<span class="w"> </span><span class="s1">'{print $1}'</span><span class="sb">`</span><span class="w"> </span><span class="c1"># (2)!</span>
</span><span id="__span-15-11"><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="nv">$CID</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-15-12"><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">'CID not found'</span>
</span><span id="__span-15-13"><span class="w">  </span><span class="nb">exit</span>
</span><span id="__span-15-14"><span class="k">fi</span>
</span><span id="__span-15-15"><span class="nb">echo</span><span class="w"> </span><span class="s1">'Setting permissions'</span>
</span><span id="__span-15-16"><span class="nb">echo</span><span class="w"> </span><span class="s2">"c </span><span class="nv">$dmajor</span><span class="s2">:</span><span class="nv">$dminor</span><span class="s2"> rwm"</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/fs/cgroup/devices/docker/<span class="nv">$CID</span>/devices.allow
</span></code></pre></div> <ol> <li>Change the name of the device, <code>zigbee</code> (to be the same as the SYMLINK name in the UDEV rule in previous step)</li> <li>Change the name of the container that needs access to the device, <code>zigbee2mqtt</code> in this example</li> </ol> </li> <li> <p>Service to launch the setup script all the time: <code>/etc/systemd/system/docker-event-listener-zigbee.service</code></p> <div class="language-ini highlight"><span class="filename">docker-event-listener-zigbee.service</span><pre><span></span><code><span id="__span-16-1"><span class="k">[Unit]</span>
</span><span id="__span-16-2"><span class="na">Description</span><span class="o">=</span><span class="s">Docker Event Listener for USB devices</span>
</span><span id="__span-16-3"><span class="na">After</span><span class="o">=</span><span class="s">network.target</span>
</span><span id="__span-16-4"><span class="na">StartLimitIntervalSec</span><span class="o">=</span><span class="s">0</span>
</span><span id="__span-16-5"><span class="k">[Service]</span>
</span><span id="__span-16-6"><span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
</span><span id="__span-16-7"><span class="na">Restart</span><span class="o">=</span><span class="s">always</span>
</span><span id="__span-16-8"><span class="na">RestartSec</span><span class="o">=</span><span class="s">1</span>
</span><span id="__span-16-9"><span class="na">User</span><span class="o">=</span><span class="s">root</span>
</span><span id="__span-16-10"><span class="na">ExecStart</span><span class="o">=</span><span class="s">/bin/bash /usr/local/bin/docker-event-listener-zigbee.sh</span>
</span><span id="__span-16-11">
</span><span id="__span-16-12"><span class="k">[Install]</span>
</span><span id="__span-16-13"><span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</span></code></pre></div> </li> <li> <p>Script triggered by the service: <code>/usr/local/bin/docker-event-listener-zigbee.sh</code></p> <div class="language-shell highlight"><span class="filename">docker-event-listener-zigbee.sh</span><pre><span></span><code><span id="__span-17-1"><span class="ch">#!/bin/bash</span>
</span><span id="__span-17-2">docker<span class="w"> </span>events<span class="w"> </span>--filter<span class="w"> </span><span class="s1">'event=start'</span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-3"><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-17-4"><span class="w">  </span>/usr/local/bin/docker-setup-zigbee.sh
</span><span id="__span-17-5"><span class="k">done</span>
</span></code></pre></div> </li> </ol> <p>Source and more details: https://github.com/Koenkk/zigbee2mqtt/issues/2049</p> <h2 id="4-cluster-configuration-and-deployment-ansible">4. Cluster configuration and deployment (Ansible)</h2> <p>At that point, I sorted all the questions I had to "translate" the compose file to work in Swarm Mode. Thinking about the cluster, you have to install docker and configure multiple machines by definition, personally, I still don't like to do things directly on the machine and if it needs to be changed, to have to figure what I did x years ago... Enter Ansible </p> <p>Ansible enables to describe a configuration state in a yaml file (Ansible playbook), and apply it to a single or set of machines. So instead of changing the target machines directly, you list tasks in the playbook and "run" the playbook... and Ansible will connect to the machines via SSH to change the configuration of them according to the playbook.</p> <h3 id="set-cgroups-config">Set cgroups config</h3> <p>The following ansible playbook snippet sets the configuration of nodes, in particular reverting to cgroup version 1 to enable the use of devices.allow and mounting the device as a volume in docker (as covered in <a href="#3-how-to-access-usb-devices-in-swarm-mode">3. How to access <strong>USB devices</strong> in swarm mode?</a>).</p> <div class="language-yaml highlight"><pre><span></span><code><span id="__span-18-1"><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Raspberry cgroup configuration.</span>
</span><span id="__span-18-2"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster</span>
</span><span id="__span-18-3"><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">init_cgroup</span>
</span><span id="__span-18-4"><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-18-5"><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-18-6">
</span><span id="__span-18-7"><span class="w">  </span><span class="nt">handlers</span><span class="p">:</span>
</span><span id="__span-18-8"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reboot-pi</span>
</span><span id="__span-18-9"><span class="w">      </span><span class="nt">reboot</span><span class="p">:</span>
</span><span id="__span-18-10">
</span><span id="__span-18-11"><span class="w">  </span><span class="nt">vars_files</span><span class="p">:</span>
</span><span id="__span-18-12"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config.yml</span>
</span><span id="__span-18-13">
</span><span id="__span-18-14"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
</span><span id="__span-18-15"><span class="w">    </span><span class="c1">#cgroups are used to limit the amount of memory that is available to a particular group of processes</span>
</span><span id="__span-18-16"><span class="w">    </span><span class="c1">#systemd.unified_cgroup_hierarchy=false switches back to cgroupv1 (for the USB devices.allow entry to work)</span>
</span><span id="__span-18-17"><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ensure cgroups are configured correctly in cmdline.txt.</span>
</span><span id="__span-18-18"><span class="w">      </span><span class="nt">ansible.builtin.replace</span><span class="p">:</span>
</span><span id="__span-18-19"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/boot/cmdline.txt</span>
</span><span id="__span-18-20"><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">'^([\w](?!.*\b{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}\b).*)$'</span>
</span><span id="__span-18-21"><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">'\1</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}'</span>
</span><span id="__span-18-22"><span class="w">      </span><span class="nt">with_items</span><span class="p">:</span>
</span><span id="__span-18-23"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"cgroup_memory=1"</span>
</span><span id="__span-18-24"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"cgroup_enable=memory"</span>
</span><span id="__span-18-25"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"systemd.unified_cgroup_hierarchy=false"</span>
</span><span id="__span-18-26"><span class="w">      </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reboot-pi</span>
</span><span id="__span-18-27"><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts['env']['SUDO_USER'] == "pi"</span><span class="w"> </span><span class="c1"># only applies on Raspberry Pis</span>
</span></code></pre></div> <h3 id="rest-of-the-playbook">Rest of the playbook</h3> <p>My playbook is based on Jeff Geerling's Turing Pi 2, where I swapped K3s for Docker Swarm Mode: https://github.com/geerlingguy/turing-pi-2-cluster</p> <p>The rest of the playbook is doing the following steps:</p> <ul> <li>Install docker on all nodes</li> <li>Configure the swarm manager (swarm join, save the token...)</li> <li>Add the worker nodes to the swarm (thanks to the manager token saved)</li> <li>Add labels to nodes</li> <li>Configure USB devices per the above "trick"</li> <li>Set a portainer service on boot</li> <li>Configure macvlan network</li> <li>Install keepalived and node_exporter</li> </ul> <p>Create an issue on GitHub if you have a question on any part of it.</p> <h1 id="random-qa-about-the-cluster">Random Q&amp;A about the cluster</h1> <h2 id="how-to-give-a-real-ip-on-the-lan-while-in-docker-swarm">How to give a "real" IP on the LAN while in Docker Swarm?</h2> <p>Initial problem: I switch Traefik as a reverse proxy (from nginx), reinstalled/reconfigured crowdsec... only to realise in Traefik <code>access.log</code> that all "external IP" (check it's actually the name in traefik) where all <strong>10.0.0.2</strong>, even when accessing my instance from Internet (from my router forwarding to Traefik). This is the IP of a Docker router part of the <code>ingress</code> network (one of the default network created in swarm). Basically, traefik can see IPs from docker network but not the actual public IPs from clients... However, that's the IP field used by crowdsec to decide if it should ban or let through the proxy. So I needed to give Traefik access to the real IP, and that's where the macvlan driver from Docker network comes into play.</p> <p>The <a href="https://docs.docker.com/network/drivers/macvlan/">macvlan driver</a> allows the container to display a MAC address to your home network (eg. your 192.168.0.0/24) and virtually be part of it.</p> <p>The catch: by construction, a macvlan network needs to know the actual network interface of the machine to talk to it - which may vary in a cluster (swarm). So you can't create a macvlan network in one go on Docker Swarm.</p> <p>The solution: </p> <ul> <li>create a <strong>configuration</strong> for a macvlan network, on each node of the cluster</li> <li>then create the actual network from a manager of the swarm</li> </ul> <p>In my case, it looks like (extract from my main ansible playbook): </p><div class="language-yaml highlight"><pre><span></span><code><span id="__span-19-1"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create macvlan network config</span>
</span><span id="__span-19-2"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker network create --config-only --subnet {{ docker_macvlan_subnet }} --gateway {{ docker_macvlan_gateway }} --ip-range {{ docker_macvlan_ip_range }} -o parent=eth0 {{ docker_macvlan_config_name }}</span>
</span></code></pre></div> Where:<p></p> <ul> <li><code>docker_macvlan_subnet</code> is your physical subnet to join, eg. <strong>192.168.0.0/24</strong></li> <li><code>docker_macvlan_gateway</code> is your gateway in that network, eg. <strong>192.168.0.1</strong>. This is important for the next parameter to work as intended.</li> <li><code>docker_macvlan_ip_range</code> is the range of IP for the containers joining that network. Here I want a static IP for Traefik, so I assigned a "range of 1 IP", for instance <strong>192.168.0.101/32</strong>. The /32 means 32 bits of the IP are used, hence this "range" is actually the 1 IP provided. This variable has been set to a different value for each node, to avoid IP clashes. </li> <li><code>parent=eth0</code> is the name of the network adapter (physical one) from the node.</li> <li><code>docker_macvlan_config_name</code> is the name of the docker network config file that will be used to create the network at the swarm level (ie. need to have one with the same name on each node to be valid).</li> </ul> <p>And to create the macvlan network: </p><div class="language-yaml highlight"><pre><span></span><code><span id="__span-20-1"><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create macvlan network</span>
</span><span id="__span-20-2"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker network create --config-from {{ docker_macvlan_config_name }} -d macvlan --scope swarm --attachable {{ docker_macvlan_net_name }}</span>
</span></code></pre></div> Where:<p></p> <ul> <li><code>docker_macvlan_config_name</code> is the name of the docker network config file above.</li> <li><code>docker_macvlan_net_name</code> is the name of the actual macvlan network your service will be joining.</li> <li>Note the <code>scope swarm</code>, and <code>attachable</code> parameters, as swarm mode services can only join networks scoped at the swarm level (ie. not a local network), so it also needs to be <strong>attachable</strong>.</li> </ul> <p>After that and to wrap up, I had to update my local DNS entries to point to the newly acquired IP for Traefik (ie. the 192.168.0.101 above, instead of the usual IP of my cluster).</p> <p>And TADA, my access.log change from having only 10.0.0.2 IPs to displaying beautiful external IPs from the clients, like 148.252.141.15: </p><div class="language-text highlight"><pre><span></span><code><span id="__span-21-1">10.0.0.2 - - [23/Sep/2023:13:49:35 +0100] "GET /apis/tasks HTTP/2.0" 304 0 "-" "-" 605 "websecure-swarmviz@docker" "IP-REDACTED" 65ms
</span><span id="__span-21-2">148.252.141.15 - - [23/Sep/2023:13:49:43 +0100] "GET /api/history/period/2023-09-23T12:49:29.348Z?filter_entity_id=sensor.processor_use&amp;end_time=2023-09-23T12:49:44.087Z&amp;skip_initial_state&amp;minimal_response HTTP/2.0" 200 10 "-" "-" 607 "websecure-homeassistant-router@file" "IP-REDACTED" 36ms
</span></code></pre></div><p></p> <h2 id="how-to-restart-all-services-if-the-cluster-cycle-power">How to restart all services if the cluster cycle power?</h2> <p>Because container (stacks) are launched and managed by portainer, I wanted portainer to restart automatically if the machine reboots, so it restarts the other containers subsequently. I decided to create a single compose file for the service "portainer" (and, in passing, the custom overlay network for others services to join).</p> <p>From portainer, the rest of the containers (in stacks) will be launched. A template is created to recreate/launch easily. Doing it from portainer allows to control the stack from the web rather than command line on the machine.</p> <h2 id="access-denied-on-files-from-a-service-eg-node-red-files">Access denied on files from a service? eg. node-red files</h2> <p>After setting up a new service, I often get "access denied" errors on volumes accessed by that service in the cluster. The example of Node-Red below is a good one to illustrate how to solve it. A change in Node-Red version is described below:</p> <blockquote> <p>Note: Users migrating from version 0.20 to 1.0 will need to ensure that any existing /data directory has the correct ownership. As of 1.0 this needs to be 1000:1000. This can be forced by the command <code>sudo chown -R 1000:1000 path/to/your/node-red/data</code> <a href="https://nodered.org/docs/getting-started/docker">From 'Running under Docker' (node-red doc)</a></p> </blockquote> <p>In my case, on my storage node, I ran: </p><div class="language-text highlight"><pre><span></span><code><span id="__span-22-1">sudo chown -R 1000:1000 /zfsdata/nfsshare/HomeAssistant/node-red
</span></code></pre></div><p></p> <h2 id="all-esphome-devices-appear-offline">All ESPHome devices appear offline?</h2> <p>On the ESPHome home page, my devices show "offline". This is due to ESPHome not resolving the device-name.local names to IP address (via mDNS), probably because of the routing in the cluster/docker networks.</p> <p>I've used a workaround for some time, by adding the following parameters to the ESPHome Docker service in docker-compose.yaml, which hardcodes the IP addresses of the devices, in the hosts file of the container: </p><div class="language-yaml highlight"><pre><span></span><code><span id="__span-23-1"><span class="w">    </span><span class="nt">extra_hosts</span><span class="p">:</span>
</span><span id="__span-23-2"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"ep1.local:&lt;IP</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">device&gt;"</span>
</span><span id="__span-23-3"><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"home-assistant-glow.local:&lt;IP</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">device&gt;"</span>
</span></code></pre></div><p></p> <p>My "fix" has been to repack the ESPHome image and adding avahi-utils to it, and allowing the container to access the dbus and avahi socket of the host (because the host resolved the *.local properly).</p> <p>To do that, I'm using the following dockerfile (image published in docker hub <a href="https://hub.docker.com/r/poulti/esphome-avahi">poulti/esphome-avahi</a>): </p><div class="language-Dockerfile highlight"><span class="filename">Dockerfile</span><pre><span></span><code><span id="__span-24-1"><span class="k">FROM</span><span class="w"> </span><span class="s">esphome/esphome:latest</span>
</span><span id="__span-24-2">
</span><span id="__span-24-3"><span class="c"># Install Avahi for mDNS (resolving .local names)</span>
</span><span id="__span-24-4"><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>avahi-utils<span class="w"> </span>-y
</span><span id="__span-24-5">
</span><span id="__span-24-6"><span class="c"># Remove apt cache (from https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)</span>
</span><span id="__span-24-7"><span class="k">RUN</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*
</span></code></pre></div><p></p> <p>And I added the following volumes to the ESPHome Docker service in docker-compose.yaml: </p><div class="language-yaml highlight"><pre><span></span><code><span id="__span-25-1"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
</span><span id="__span-25-2"><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">(...)</span>
</span><span id="__span-25-3"><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain"># Added Avahi deamon socket to run avahi-browse using the cache from the host node</span>
</span><span id="__span-25-4"><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">- /var/run/dbus:/var/run/dbus</span>
</span><span id="__span-25-5"><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">- /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket</span>
</span></code></pre></div><p></p> <h2 id="migration-steps-from-desktop-to-turing-pi-cluster">Migration steps from desktop to Turing Pi cluster</h2> <p>Switching from Docker running on a Windows desktop to a Turing pi Cluster, here are all the steps I took to migrate</p> <p>Physical world: - [ ] Flash modules: 2x raspberry emmc, 1x micro sd card raspberry, 1x RK1 emmc - [ ] Install mobo and power supply, connect Pi, RK1, SSDs - [ ] Test boot OK and connect to Turing Pi BMC (https://turingpi/ by default) - [ ] Configure USB2 to the right Turing Pi node On my computer: - [ ] Run first Ansible ping / accept SSH keys - [ ] Check Ansible config.yml for correct true/false settings (eg. to run the install of storage) - [ ] Test Ansible setup playbooks (swarm activation + NFS setup) by adding <code>--check</code> to the command - [ ] Copy the container config data from desktop disk to the NFS storage Docker compose yaml: - [ ] Change Docker Volumes to NFS binds - [ ] Change Frigate image to the right CPU arch type Physical world: - [ ] Connect USB devices to the right USB ports on Turing Pi - [ ] Change the port forwarding rule from external IP - [ ] Shutdown everything on desktop and deploy the stacks on the cluster</p> <aside class="md-source-file"> <span class="md-source-file__fact"> <span class="md-icon" title="Last update"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="October 21, 2025 05:53:32 UTC">October 21, 2025</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class="md-footer"> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> <div class="md-copyright__highlight"> Copyright © 2025 Poulti </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener"> Material for MkDocs </a> </div> <div class="md-social"> <a href="https://twitter.com/poulti" target="_blank" rel="noopener" title="twitter.com" class="md-social__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"></path></svg> </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.code.annotate"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>